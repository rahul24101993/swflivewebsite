#!/usr/bin/env node

const { join } = require( 'path' );
const declLoader = require( '../rewired/declLoader' );
const {
    getBuildJson,
    getAliasMap
} = require( '../rewired/utils' );

const PerformanceTracker = require( '../js/PerformanceTracker' );

/**
 * initialize alias map first this alias maps gets used for view deps
 */
const initializeAliasMap = () => {
    const buildJson = getBuildJson();
    const { aliasMap } = getAliasMap( buildJson.srcPaths, true );
    // console.log( aliasMap );
}

initializeAliasMap();
const viewModelPath = process.cwd() + '/test/viewmodel/ComplexPerformanceTestViewModel.json';
const viewModel = require( viewModelPath );

let performanceTracker = new PerformanceTracker();
performanceTracker.performPerformanceTestingForGivenSyncFunction( compilerPerformanceTesting );

function compilerPerformanceTesting() {
    for( let i = 1; i <= 1000; i++ ) {
        const testComponent = declLoader( viewModel, viewModelPath );
        // console.log( testComponent );
        // uncomment following lines to create heap snapshots
        // if( i % 500 === 0 ) {
        //     console.log( `Heap snapshot after ${i} view model processing..` );
        //     performanceTracker.createHeapSnapshot();
        // }
    }
}
/**
 * Readings- 15/07/2021

*****Performance Testing Logs*****

┌─────────────┬──────────────┐
│   (index)   │    Values    │
├─────────────┼──────────────┤
│  duration   │ '7197.26 ms' │
│ memoryUsage │ '612.55 MB'  │
└─────────────┴──────────────┘

 */
