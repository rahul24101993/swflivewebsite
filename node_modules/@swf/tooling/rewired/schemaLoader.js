// Copyright (c) 2022 Siemens

const fs = require( 'fs' );
const path = require( 'path' );
const { createSchema } = require( '../js/genSchema' );
const { Stopwatch } = require( './perfUtils' );

/**
 * main function of schema json loader
 * @param {string} source input file content
 * @returns {string} modified source as return value
 */
module.exports = function( source, map, meta ) {
    const stopwatch = new Stopwatch( 'schemaLoader' );

    var callback = this.async();

    if( fs.existsSync( path.resolve( process.cwd(), './src/soa' ) ) ) {
        createSchema().then( ( schema ) => {
            const contents = source.replace( '\'//schema\'', schema );
            stopwatch.end();
            callback( null, contents, map, meta );
        } );
    } else {
        const contents = source.replace( '\'//schema\'', JSON.stringify( {} ) );
        stopwatch.end();
        callback( null, contents, map, meta );
    }
};
