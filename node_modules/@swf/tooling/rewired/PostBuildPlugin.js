// Copyright (c) 2022 Siemens

const { symLink } = require( '../js/util' );
const { getBuildJson } = require( './utils' );
const { Stopwatch } = require( './perfUtils' );

class PostBuildPlugin {
    constructor( siteName ) {
        const stopwatch = new Stopwatch( 'PostBuildPlugin' );
        this.siteName = siteName;
        stopwatch.end();
    }

    apply( compiler ) {
        compiler.hooks.done.tapPromise( 'PostBuildPlugin', async( source, target, routesList ) => {
            const buildJson = getBuildJson();
            if( !buildJson.siteOutDir ) {
                await symLink( `${process.cwd()}/out/site_last`, `${process.cwd()}/out/site/${this.siteName}` );
            }
        } );
    }
}

module.exports = PostBuildPlugin;
