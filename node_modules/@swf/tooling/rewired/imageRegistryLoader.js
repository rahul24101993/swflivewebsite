// Copyright (c) 2022 Siemens

const { getImageAlias } = require( './utils' );
const _ = require( 'lodash' );
const { Stopwatch } = require( './perfUtils' );

/**
 * main function of decl loader
 * @param {string} source input file content
 * @returns {string} modified source as return value
 */
module.exports = function loader( source ) {
    const stopwatch = new Stopwatch( 'imageRegistryLoader' );

    // Generate module regex
    const imageAlias = getImageAlias();
    const res = [];
    const imageDynamicImports = [];
    res.push( 'AFX_CONFIG_ENTRY' );
    imageDynamicImports.push( 'AFX_CONFIG_REGISTER_IMAGES' );

    for( let item of imageAlias.values() ) {
        if( /\.svg$/.test( item ) && /^image[\\/]type\S+/.test( item ) === false ) {
            res.push( `'${item}'` );
            imageDynamicImports.push( `registerDynImportEntry('${item}', () => import('${item}'));` );
        }
    }

    source = source.replace( 'AFX_CONFIG_ENTRY', res.join( ',\n' ) );
    const output = source.replace( 'AFX_CONFIG_REGISTER_IMAGES', imageDynamicImports.join( '\n' ) );
    stopwatch.end();
    return output;
};
