// Copyright (c) 2022 Siemens

const { getModuleScssFiles, getThemeScssFiles } = require( './utils' );
const { Stopwatch } = require( './perfUtils' );

/**
 * main function of decl loader
 * @param {string} source input file content
 */
module.exports = function loader( source ) {
    const stopwatch = new Stopwatch( 'afxSassLoader' );

    let scssFile = source.toString().trim();
    // pre sass loader processing
    if( scssFile.includes( 'AFX_MODULE_SCSS_PATHS' ) ) {
        const moduleCssFiles = getModuleScssFiles();
        const imports = moduleCssFiles.map( x => `@import '${x}';` ).join( '\n' );
        scssFile = scssFile.replace( /\/\/'AFX_MODULE_SCSS_PATHS';/g, imports );
    }
    if( scssFile.includes( 'AFX_MODULE_THEME_SCSS_PATHS' ) ) {
        const moduleThemeFiles = getThemeScssFiles();
        const imports = moduleThemeFiles.map( x => `@import '${x}';` ).join( '\n' );
        scssFile = scssFile.replace( /\/\/'AFX_MODULE_THEME_SCSS_PATHS';/g, imports );
    }
    // post sass loader processing
    //convert url("./image/xyz.svg") to url("~image/xyz.svg")
    //convert url(./image/xyz.svg) to url(~image/xyz.svg)
    //convert url("./images/xyz.svg") to url("~images/xyz.svg")
    //convert url(./images/xyz.svg) to url(~images/xyz.svg)
    scssFile = scssFile.replace( /url\("[^")]*\/image\//g, 'url("~image/' ).replace( /url\(\.[^")]*\/image\//g, 'url(~image/' );
    scssFile = scssFile.replace( /url\("[^")]*\/images\//g, 'url("~images/' ).replace( /url\(\.[^")]*\/images\//g, 'url(~images/' );
    // scssFile = scssFile.replace( /url\(("?)[^")]*\/(images?)\//g, 'url($1~$2/' );

    stopwatch.end();

    return scssFile;
};
