/* eslint-disable complexity */
// Copyright (c) 2020 Siemens

import { interopES6Default } from './utils';
import { registerDynImportEntry } from 'js/moduleLoader';

/**
 * parse return value webpack.require.context to module object array
 * @param {Array} imports module structure return by webpack.require.context API
 * @returns {Object} module object array
 */
const parseImports = imports => imports.reduce( ( res, m ) =>
    res.concat( m.keys().map( path => ( {
        name: path,
        loadFn: async () => interopES6Default( await m( path ) )
    } ) ) ), [] );

/**
 * property policy loader
 *
 * @module js/propertyPolicyLoaderService
 *
 * @namespace viewModelLoader
 */
const init = () => {
    // this method will be used by build time injected code
    const registerPropertyPolicies = ( imports ) => {
        const modules = parseImports( imports );
        modules.forEach( ( m ) => {
            // register for with file name extension use case "policies/favoritesLocationPropertyPolicy.json"
            const moduleName1 = m.name.replace( /^.*[\\/](policies[\\/][^\\//]*PropertyPolicy)/, '$1' );
            registerDynImportEntry( moduleName1, m.loadFn );
            // register for without file name extension use case "policies/favoritesLocationPropertyPolicy"
            const moduleName2 = m.name.replace( /^.*[\\/](policies[\\/][^\\//]*PropertyPolicy)\.json$/, '$1' );
            registerDynImportEntry( moduleName2, m.loadFn );
        } );
    };
    // AFX_PROPERTY_POLICY_REGISTRATION
};

// pre-load property policy for dynamic import
init();
