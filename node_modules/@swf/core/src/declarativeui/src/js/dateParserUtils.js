// Copyright (c) 2020 Siemens

/**
 * Module for date parser utilities
 *
 * @module js/dateParserUtils
 */
import _ from 'lodash';
import Debug from 'debug';

var trace = new Debug( 'dateParserUtils' );
var exports = {};

/**
 *Parsing of Dates
 *
 * @param {String} sourceVal - property value to compare with
 * @param {String} queryVal - condition value
 *
 * @return {Object} date object of sourceVal and queryVal
 */
export let getParsedDates = function( sourceVal, queryVal ) {
    var dateParser = {};

    dateParser.sourceDate = exports.convertDateToMsec( sourceVal );

    if( _.isArray( queryVal ) ) {
        dateParser.queryDate = [];
        for( var key in queryVal ) {
            dateParser.queryDate[ key ] = exports.convertDateToMsec( queryVal[ key ] );
        }
    } else {
        dateParser.queryDate = exports.convertDateToMsec( queryVal );
    }

    return dateParser;
};

/**
 *Get widget type like  date/time/datetime
 *
 * @param {String} condition - condition value like "Date(08-Feb-2019)"
 *
 * @return {String}  conditionVal like "08-Feb-2019"
 */
export let getDateValue = function( condition ) {
    try {
        var regExp = /\(([^)]+)\)/;
        return regExp.exec( condition )[ 1 ];
    } catch ( e ) {
        trace( 'Error in condition', e, condition );
    }
    return undefined;
};

/**
 *Get widget type like  date/time/datetime
 *
 * @param {object} value - date object
 * @param {String} expressionDataType - data type - Date
 * @return {object}  expression , date type along with date
 */
export let getExpressionDateValue = function( value, expressionDataType ) {
    var key;
    var expression = {};
    if( expressionDataType === 'Date' && exports.isDate( value ) ) {
        if( _.isArray( value ) ) {
            expression.value = [];
            for( key in value ) {
                expression.value[ key ] = exports.getDateValue( value[ key ] );
            }
        } else {
            expression.value = exports.getDateValue( value );
        }
    } else {
        expression.value = value;
    }
    return expression;
};

/**
 *get expression type is dat eor not
 *
 * @param {object} value - date object
 *
 * @return {boolean}  value is date or not
 */
export let isDate = function( value ) {
    try {
        var regExp = /^Date\(\{\{/;
        return value && value.toString().match( regExp ) !== null;
    } catch ( e ) {
        trace( 'Error in expression', e, value );
    }
    return undefined;
};

/**
 * get date  in milliseconds
 *
 * @param {Object} queryVal value
 *
 * @return {Date} - in milliseconds
 */
export let convertDateToMsec = function( queryVal ) {
    if( typeof queryVal !== 'number' ) {
        try {
            queryVal = new Date( queryVal ).getTime();
        } catch ( e ) {
            trace( 'Invalid Date format', e );
        }
    }
    return queryVal > 0 ? queryVal : Infinity;
};

exports = {
    getParsedDates,
    getDateValue,
    getExpressionDateValue,
    isDate,
    convertDateToMsec
};
export default exports;
