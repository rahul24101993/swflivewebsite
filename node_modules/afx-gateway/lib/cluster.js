const cluster = require( 'cluster' );
const os = require( 'os' );

const trace = require( 'debug' )( 'expressServer:logger' );

/**
 * Changing scheduling policy to 2 i.e. cluster.SCHED_RR because that is not the default option for windows OS.
 * Please refer to below documentation
 *
 * https://nodejs.org/docs/latest-v10.x/api/cluster.html#cluster_cluster_schedulingpolicy
 */
cluster.schedulingPolicy = 2;

if( cluster.isMaster ) {
    let cpus = os.cpus().length;
    trace( 'Forking for ' + cpus + ' CPUs' );

    for( let i = 0; i < cpus; i++ ) {
        cluster.fork();
    }

    cluster.on( 'error', function( worker ) {
        trace( `Worker error ${worker.process.pid}` );
    } );

    // listen for dying workers
    cluster.on( 'disconnect', function( worker, code, signal ) {
        trace( `Worker ${worker.process.pid} died with code: ${code} and signal ${signal}. Starting a new worker` );
        cluster.fork();
    } );
} else {
    trace( `Worker ${process.pid} started` );
    require( './express' );
}
